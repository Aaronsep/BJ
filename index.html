<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Balanceador óptimo de trabajos</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121623;
      --panel2:#0f1320;
      --text:#e9eefc;
      --muted:#a9b4d0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --accent:#7aa2ff;
      --ok:#33d1a0;
      --bad:#ff5d5d;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 15%, rgba(51,209,160,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{ max-width: 1100px; margin: 28px auto; padding: 0 18px 40px; }
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:18px; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{ margin:0; font-size: 22px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; max-width: 780px; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04);
      color: var(--muted); font-size:12px;
    }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      background: rgba(0,0,0,.15);
    }
    .card-h b{ font-size:13px; letter-spacing:.2px; }
    .card-b{ padding: 14px; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 160px;
    }
    label{ font-size:12px; color: var(--muted); }
    input[type="number"], input[type="text"]{
      width:100%;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(233,238,252,.35); }
    input:focus{ border-color: rgba(122,162,255,.55); box-shadow: 0 0 0 3px rgba(122,162,255,.18); }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .04s ease, border-color .15s ease, background .15s ease;
      font-weight: 600;
      letter-spacing:.2px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(122,162,255,.45);
      background: rgba(122,162,255,.14);
    }
    .btn.good{
      border-color: rgba(51,209,160,.45);
      background: rgba(51,209,160,.12);
    }
    .btn.bad{
      border-color: rgba(255,93,93,.45);
      background: rgba(255,93,93,.10);
    }
    .btn.icon{
      width:42px; padding:10px 0; display:inline-grid; place-items:center;
    }

    .hint{
      font-size:12px; color: var(--muted); line-height:1.4;
      margin-top:10px;
    }
    .hint code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
      margin-top: 10px;
    }
    .rowItem{
      display:grid;
      grid-template-columns: 1fr 150px 44px;
      gap:10px;
      align-items:center;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
    }
    @media (max-width: 720px){
      .rowItem{ grid-template-columns: 1fr; }
      .rowItem .del{ justify-self:end; }
    }
    .mini{ font-size:12px; color: var(--muted); margin-top:8px; }
    .status{ font-size:12px; margin-top:10px; color: var(--muted); }
    .ok{ color: var(--ok); }
    .badTxt{ color: var(--bad); }
    .errBox{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,93,93,.55);
      background: rgba(255,93,93,.08);
      white-space: pre-wrap;
      font-size:12px;
      line-height:1.35;
    }

    pre{
      margin:0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      line-height:1.4;
    }

    .footerBtns{ display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Balanceador óptimo de trabajos</h1>
        <div class="sub">
          Añade trabajos con nombre y duración. Duración aceptada: <code>1.56</code> (horas decimales) o <code>2:25</code> (h:mm).
          Luego elige K equipos y resuelve.
        </div>
      </div>
      <div class="pill">
        Óptimo = minimiza el tiempo del equipo más cargado
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <b>Trabajos</b>
          <div class="footerBtns">
            <button id="addBtn" class="btn icon primary" type="button" title="Añadir trabajo">+</button>
            <button id="demoBtn" class="btn" type="button">Demo</button>
            <button id="clearBtn" class="btn bad" type="button">Vaciar</button>
          </div>
        </div>
        <div class="card-b">
          <div class="controls">
            <div class="field" style="flex:1; min-width:260px;">
              <label>Nombre</label>
              <input id="nameIn" type="text" placeholder="Ej: 4567 Dinasty Road" />
            </div>
            <div class="field" style="min-width:190px;">
              <label>Duración</label>
              <input id="durIn" type="text" placeholder="Ej: 1.56 o 2:25" />
            </div>
            <div style="align-self:end;">
              <button id="addBtn2" class="btn primary" type="button">Añadir</button>
            </div>
          </div>

          <div class="hint">
            Tip: si tu duración viene como “7.8” eso significa 7.8 horas (7h 48m). Si quieres 7h 08m usa <code>7:08</code>.
          </div>

          <div class="list" id="list"></div>
          <div class="mini" id="countInfo"></div>

          <div class="errBox" id="errBox"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <b>Resolver</b>
          <div class="footerBtns">
            <button id="solveBtn" class="btn good" type="button">Resolver óptimo</button>
            <button id="copyBtn" class="btn" type="button">Copiar resultado</button>
          </div>
        </div>
        <div class="card-b">
          <div class="controls">
            <div class="field">
              <label>Equipos (K)</label>
              <input id="k" type="number" min="1" value="2" />
            </div>
            <div class="field">
              <label>Precisión (min/unidad)</label>
              <input id="quant" type="number" min="1" value="1" />
            </div>
          </div>

          <div class="status" id="status"></div>
          <pre id="out"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const elList = $('list');
  const elCount = $('countInfo');
  const elErr = $('errBox');
  const elOut = $('out');
  const elStatus = $('status');

  const elNameIn = $('nameIn');
  const elDurIn = $('durIn');

  let jobs = [];
  let jobId = 1;

  function showError(msg){
    elErr.style.display = 'block';
    elErr.textContent = msg;
  }
  function clearError(){
    elErr.style.display = 'none';
    elErr.textContent = '';
  }

  function parseTimeToMinutes(s){
    s = String(s ?? '').trim();
    if (!s) throw new Error('Duración vacía');

    if (s.includes(':')) {
      const parts = s.split(':');
      if (parts.length !== 2) throw new Error('Tiempo inválido: ' + s);
      const hh = parseInt(parts[0].trim(),10);
      const mm = parseInt(parts[1].trim(),10);
      if (!Number.isFinite(hh) || !Number.isFinite(mm)) throw new Error('Tiempo inválido: ' + s);
      if (mm < 0 || mm > 59) throw new Error('Minutos deben ser 0..59: ' + s);
      return hh*60 + mm;
    }

    // horas decimales
    s = s.replace(',', '.');
    const hours = parseFloat(s);
    if (!Number.isFinite(hours)) throw new Error('Tiempo inválido: ' + s);
    const minutes = Math.round(hours * 60);
    if (minutes <= 0) throw new Error('Duración debe ser > 0');
    return minutes;
  }

  function hhmm(min){
    const h = Math.floor(min/60);
    const m = min%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  }

  function render(){
    elList.innerHTML = '';

    jobs.forEach((j) => {
      const row = document.createElement('div');
      row.className = 'rowItem';

      const name = document.createElement('input');
      name.type = 'text';
      name.value = j.name;
      name.placeholder = 'Nombre';
      name.addEventListener('input', () => { j.name = name.value; });

      const dur = document.createElement('input');
      dur.type = 'text';
      dur.value = j.durRaw;
      dur.placeholder = 'Duración (1.56 o 2:25)';
      dur.addEventListener('input', () => { j.durRaw = dur.value; });

      const del = document.createElement('button');
      del.className = 'btn icon bad del';
      del.type = 'button';
      del.textContent = '✕';
      del.title = 'Eliminar';
      del.addEventListener('click', () => {
        jobs = jobs.filter(x => x.id !== j.id);
        render();
      });

      row.appendChild(name);
      row.appendChild(dur);
      row.appendChild(del);
      elList.appendChild(row);
    });

    elCount.textContent = `Trabajos: ${jobs.length}`;
  }

  function addJob(name, durRaw){
    clearError();
    const n = String(name ?? '').trim();
    const d = String(durRaw ?? '').trim();
    if (!n) throw new Error('Falta el nombre');
    // valida duración al agregar (así no te enteras hasta resolver)
    parseTimeToMinutes(d);

    jobs.push({ id: jobId++, name: n, durRaw: d });
    render();
  }

  function addFromInputs(){
    try{
      addJob(elNameIn.value, elDurIn.value);
      elNameIn.value = '';
      elDurIn.value = '';
      elNameIn.focus();
    } catch(e){
      showError(e && e.message ? e.message : String(e));
    }
  }

  $('addBtn').addEventListener('click', addFromInputs);
  $('addBtn2').addEventListener('click', addFromInputs);

  elDurIn.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') addFromInputs();
  });
  elNameIn.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') elDurIn.focus();
  });

  $('clearBtn').addEventListener('click', () => {
    jobs = [];
    render();
    elOut.textContent = '';
    elStatus.textContent = '';
    clearError();
  });

  $('demoBtn').addEventListener('click', () => {
    jobs = [
      {id: jobId++, name:'4567 Dinasty Road', durRaw:'1.56'},
      {id: jobId++, name:'Cableado cocina', durRaw:'2:15'},
      {id: jobId++, name:'Pintura recámara', durRaw:'3.10'},
      {id: jobId++, name:'Limpieza patio', durRaw:'0:45'},
      {id: jobId++, name:'Instalación lámparas', durRaw:'1:20'},
      {id: jobId++, name:'Revisión plomería', durRaw:'2.05'},
    ];
    render();
    clearError();
  });

  function solveOptimal(jobsMinutes, K, quant){
    const q = Math.max(1, quant|0);

    const minMap = new Map();
    for (const j of jobsMinutes) minMap.set(j.name, j.minutes);

    const items = jobsMinutes
      .map(j => ({name: j.name, w: Math.max(1, Math.round(j.minutes / q))}))
      .sort((a,b)=>b.w-a.w);

    const n = items.length;
    const total = items.reduce((s,x)=>s+x.w,0);

    // Upper bound inicial (LPT)
    const loads0 = Array(K).fill(0);
    const assign0 = Array.from({length: K}, ()=>[]);
    for (const it of items){
      let best = 0;
      for (let i=1;i<K;i++) if (loads0[i] < loads0[best]) best = i;
      loads0[best] += it.w;
      assign0[best].push(it);
    }
    let bestMakespan = Math.max(...loads0);
    let bestAssign = assign0.map(a=>a.slice());

    const avgLB = Math.ceil(total / K);

    const loads = Array(K).fill(0);
    const assign = Array.from({length: K}, ()=>[]);

    const seen = new Set();
    function key(idx){
      const sorted = loads.slice().sort((a,b)=>a-b).join(',');
      return idx + '|' + sorted;
    }

    function dfs(idx){
      if (idx === n){
        const mk = Math.max(...loads);
        if (mk < bestMakespan){
          bestMakespan = mk;
          bestAssign = assign.map(a=>a.slice());
        }
        return;
      }

      const currentMax = Math.max(...loads);
      const lb = Math.max(avgLB, currentMax);
      if (lb >= bestMakespan) return;

      const k = key(idx);
      if (seen.has(k)) return;
      seen.add(k);

      const it = items[idx];

      const triedLoads = new Set();
      const order = Array.from({length: K}, (_,i)=>i).sort((a,b)=>loads[a]-loads[b]);

      for (const i of order){
        const L = loads[i];
        if (triedLoads.has(L)) continue;
        triedLoads.add(L);

        const newLoad = L + it.w;
        if (newLoad >= bestMakespan) continue;

        loads[i] = newLoad;
        assign[i].push(it);

        dfs(idx+1);

        assign[i].pop();
        loads[i] = L;

        if (L === 0) break; // simetría: equipos vacíos equivalentes
      }
    }

    dfs(0);

    const teams = bestAssign.map(team => {
      const jobsTeam = team.map(it => ({ name: it.name, minutes: minMap.get(it.name) ?? it.w*q }));
      jobsTeam.sort((a,b)=>b.minutes-a.minutes);
      const sumMin = jobsTeam.reduce((s,x)=>s+x.minutes,0);
      return { jobs: jobsTeam, totalMinutes: sumMin };
    });

    return { teams };
  }

  $('solveBtn').addEventListener('click', () => {
    clearError();
    elOut.textContent = '';
    try{
      const K = parseInt($('k').value, 10);
      const quant = parseInt($('quant').value, 10);
      if (!Number.isFinite(K) || K < 1) throw new Error('K inválido');
      if (!Number.isFinite(quant) || quant < 1) throw new Error('Precisión inválida');
      if (jobs.length === 0) throw new Error('No hay trabajos');

      // materializa minutos y valida todo
      const jobsMinutes = jobs.map((j, idx) => {
        const name = String(j.name ?? '').trim();
        if (!name) throw new Error(`Trabajo ${idx+1}: falta nombre`);
        const minutes = parseTimeToMinutes(j.durRaw);
        return { name, minutes };
      });

      if (jobsMinutes.length > 90 && quant === 1){
        elStatus.innerHTML = `<span class="badTxt">Advertencia:</span> con muchos trabajos, óptimo al minuto puede tardar. Sube Precisión a 5 o 10 si se tarda.`;
      } else {
        elStatus.textContent = 'Resolviendo (óptimo)...';
      }

      setTimeout(() => {
        try{
          const t0 = performance.now();
          const res = solveOptimal(jobsMinutes, K, quant);
          const t1 = performance.now();

          const totals = res.teams.map(t=>t.totalMinutes);
          const minT = Math.min(...totals);
          const maxT = Math.max(...totals);

          let out = '';
          out += `Equipos: ${K}\n`;
          out += `Trabajos: ${jobsMinutes.length}\n`;
          out += `Makespan óptimo: ${maxT} min (${hhmm(maxT)})\n`;
          out += `Min total: ${minT} min (${hhmm(minT)})\n`;
          out += `Diferencia: ${maxT - minT} min (${hhmm(maxT - minT)})\n`;
          out += `Tiempo de cómputo: ${Math.round(t1 - t0)} ms\n\n`;

          res.teams.forEach((team, idx) => {
            out += `Equipo ${idx+1} | Total: ${team.totalMinutes} min (${hhmm(team.totalMinutes)})\n`;
            team.jobs.forEach(j => {
              out += `  - ${j.name} - ${j.minutes} min (${hhmm(j.minutes)})\n`;
            });
            out += `\n`;
          });

          elOut.textContent = out;
          elStatus.innerHTML = '<span class="ok">Listo.</span>';
        } catch(e2){
          elStatus.innerHTML = '<span class="badTxt">Error al resolver.</span>';
          showError(e2 && e2.message ? e2.message : String(e2));
        }
      }, 10);

    } catch(e){
      elStatus.innerHTML = '<span class="badTxt">Error.</span>';
      showError(e && e.message ? e.message : String(e));
    }
  });

  $('copyBtn').addEventListener('click', async () => {
    try{
      const text = elOut.textContent || '';
      if (!text.trim()) throw new Error('No hay resultado para copiar');
      await navigator.clipboard.writeText(text);
      elStatus.innerHTML = '<span class="ok">Copiado.</span>';
    } catch(e){
      showError(e && e.message ? e.message : String(e));
    }
  });

  // 1 fila inicial para guiar
  jobs = [{ id: jobId++, name: '', durRaw: '' }];
  render();
})();
</script>
</body>
</html>